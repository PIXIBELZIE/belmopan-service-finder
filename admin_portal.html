<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belmopan Service Finder - Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af',
                        'secondary-yellow': '#facc15',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar for better visibility */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen p-4 sm:p-8">
    
    <div id="loading-screen" class="fixed inset-0 bg-white/90 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-blue mx-auto"></div>
            <p class="mt-4 text-xl font-semibold text-primary-blue">Loading Secure Admin Portal...</p>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto opacity-0 transition-opacity duration-300">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center">
                <svg class="w-8 h-8 mr-2 text-primary-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Belmopan Service Admin
            </h1>
            <p class="text-sm text-gray-500 mt-1">
                Authenticated User ID: <span id="user-id" class="font-mono text-xs bg-gray-200 px-2 py-0.5 rounded">...</span>
                <span class="ml-4 text-red-600 font-bold hidden" id="error-message"></span>
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Vendor Submission Form -->
            <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                <h2 class="text-2xl font-bold mb-4 text-primary-blue">Add New Service/Vendor</h2>
                <form id="vendor-form" class="space-y-4">
                    <input type="hidden" id="vendor-id">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Vendor/Service Name</label>
                        <input type="text" id="name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue border p-2">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="category" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue border p-2 bg-white">
                            <option value="">Select Category</option>
                            <option value="Food">Food & Beverage</option>
                            <option value="Government">Government & Public</option>
                            <option value="Health">Health & Wellness</option>
                            <option value="Education">Education</option>
                            <option value="Retail">Retail & Shopping</option>
                            <option value="Services">Professional Services</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="contact" class="block text-sm font-medium text-gray-700">Contact (Phone/Email)</label>
                        <input type="text" id="contact" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue border p-2">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700">Location/Address</label>
                        <input type="text" id="location" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue border p-2">
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="description" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue border p-2"></textarea>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="approved" class="rounded text-primary-blue shadow-sm focus:ring-primary-blue">
                            <span class="ml-2 text-sm font-medium text-gray-700">Approved (Show on Public Site)</span>
                        </label>
                    </div>
                    <button type="submit" id="submit-button" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition duration-150 ease-in-out">
                        Add Vendor
                    </button>
                    <button type="button" id="clear-button" class="w-full py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150 ease-in-out">
                        Clear Form
                    </button>
                </form>
            </section>

            <!-- Vendor List and Management -->
            <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-primary-blue">Manage Existing Services</h2>
                
                <!-- Search and Filter -->
                <div class="mb-4 flex flex-col sm:flex-row gap-4">
                    <input type="text" id="search-input" placeholder="Search by name or description..." class="flex-grow rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue border p-2">
                    <select type="text" id="filter-status" class="w-full sm:w-40 rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue border p-2 bg-white">
                        <option value="all">Status: All</option>
                        <option value="approved">Approved</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>

                <!-- Vendor List -->
                <div id="vendor-list" class="space-y-4 h-[70vh] overflow-y-auto custom-scroll">
                    <p id="list-message" class="text-gray-500 text-center py-8">No services loaded yet or list is empty.</p>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Custom Modal for Confirmation/Alerts -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">Confirm Deletion</h3>
            <p id="modal-body" class="mb-4 text-gray-700">Are you sure you want to delete this vendor?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">Cancel</button>
                <button id="modal-confirm" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Robust Fallback Firebase Configuration (Must contain all keys Auth needs) ---
        const fallbackFirebaseConfig = {
            apiKey: "AIzaSyDIAumG4P2VVTZiPHCCwsymlt9p8bTcJxA",
            // CRITICAL KEY: This is the domain Firebase Auth uses for communication.
            authDomain: "belmopanservicefinder.firebaseapp.com", 
            projectId: "belmopanservicefinder",
            storageBucket: "belmopanservicefinder.firebasestorage.app",
            messagingSenderId: "527595910485",
            appId: "1:527595910485:web:dec51922c6f9549cfaebdc",
            measurementId: "G-QRD4ZSXCSM"
        };
        
        // --- Global Variables (Canvas Environment or Fallback) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 1. Get environment config if present
        const envConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {};

        // 2. CRITICAL MERGE: Merge environment config over fallback config, prioritizing
        // keys in the environment, but ensuring the fallback provides missing critical keys.
        let firebaseConfig = { ...fallbackFirebaseConfig, ...envConfig };
        
        // 3. FINAL SAFETY CHECK: If the merged config still lacks authDomain, use the fallback's
        if (!firebaseConfig.authDomain && fallbackFirebaseConfig.authDomain) {
            firebaseConfig.authDomain = fallbackFirebaseConfig.authDomain;
            console.warn("FIREBASE CONFIGURATION WARNING: 'authDomain' was missing from environment config and was injected from the fallback. This prevents (auth/configuration-not-found) errors.");
        }


        let app;
        let db;
        let auth;
        let userId;

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const appContainer = document.getElementById('app-container');
        const userIdDisplay = document.getElementById('user-id');
        const errorMessage = document.getElementById('error-message');
        const vendorForm = document.getElementById('vendor-form');
        const vendorListElement = document.getElementById('vendor-list');
        const listMessage = document.getElementById('list-message');
        const submitButton = document.getElementById('submit-button');
        const clearButton = document.getElementById('clear-button');
        const searchInput = document.getElementById('search-input');
        const filterStatus = document.getElementById('filter-status');
        
        // Modal elements
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        
        // State
        let allVendors = [];
        let currentFilter = { search: '', status: 'all' };

        // --- Utility Functions ---

        // Simple confirmation modal function (to replace window.confirm/alert)
        const showModal = (title, body, confirmText = 'Confirm', isDestructive = true) => {
            return new Promise(resolve => {
                modalTitle.textContent = title;
                modalBody.textContent = body;
                modalConfirm.textContent = confirmText;
                
                // Style modal based on action type
                modalTitle.className = `text-xl font-bold mb-3 ${isDestructive ? 'text-red-600' : 'text-primary-blue'}`;
                modalConfirm.className = `py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white ${isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-primary-blue hover:bg-blue-700'}`;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const handleConfirm = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modalConfirm.removeEventListener('click', handleConfirm);
                    modalCancel.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modalConfirm.removeEventListener('click', handleConfirm);
                    modalCancel.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                modalConfirm.addEventListener('click', handleConfirm);
                modalCancel.addEventListener('click', handleCancel);
            });
        };


        // --- Firestore Management ---

        const getVendorCollectionRef = () => {
            // Public data path: /artifacts/{appId}/public/data/vendors
            // We use the projectId from the config as a safeguard for appId if the environment variable fails
            const safeAppId = firebaseConfig.projectId || appId;
            return collection(db, 'artifacts', safeAppId, 'public', 'data', 'vendors');
        };

        const saveVendor = async (vendorData) => {
            try {
                const docRef = vendorData.id
                    ? doc(getVendorCollectionRef(), vendorData.id)
                    : null;

                const dataToSave = {
                    name: vendorData.name,
                    category: vendorData.category,
                    contact: vendorData.contact,
                    location: vendorData.location,
                    description: vendorData.description,
                    approved: vendorData.approved,
                    // Use serverTimestamp() for reliable time
                    updatedAt: serverTimestamp(), 
                    // Add a creation timestamp only if it's a new document
                    ...(docRef ? {} : { 
                        createdAt: serverTimestamp(),
                        submittedBy: userId // Track who first created it
                    }), 
                };

                if (docRef) {
                    await updateDoc(docRef, dataToSave);
                    console.log("Document updated successfully:", vendorData.id);
                } else {
                    const newDocRef = await addDoc(getVendorCollectionRef(), dataToSave);
                    console.log("Document written with ID:", newDocRef.id);
                }

                await showModal('Success', 'Vendor data saved successfully.', 'OK', false);
                clearForm();
            } catch (error) {
                console.error("Error saving vendor:", error);
                await showModal('Error', 'Failed to save vendor data. Check console for details.', 'Close', true);
            }
        };

        const deleteVendor = async (vendorId) => {
            const confirmed = await showModal(
                'Confirm Deletion',
                'Are you absolutely sure you want to delete this vendor? This cannot be undone.',
                'Delete Permanently'
            );

            if (confirmed) {
                try {
                    await deleteDoc(doc(getVendorCollectionRef(), vendorId));
                    console.log("Document deleted successfully:", vendorId);
                    await showModal('Deleted', 'Vendor has been successfully deleted.', 'OK', false);
                    clearForm();
                } catch (error) {
                    console.error("Error deleting document:", error);
                    await showModal('Error', 'Failed to delete vendor. Check console for details.', 'Close', true);
                }
            }
        };

        const renderVendorList = () => {
            const { search, status } = currentFilter;
            
            let filteredVendors = allVendors.filter(vendor => {
                // 1. Search Filter
                const searchTerm = search.toLowerCase();
                const matchesSearch = !searchTerm || 
                    vendor.name.toLowerCase().includes(searchTerm) || 
                    (vendor.description && vendor.description.toLowerCase().includes(searchTerm)) ||
                    vendor.category.toLowerCase().includes(searchTerm);

                // 2. Status Filter
                const matchesStatus = status === 'all' || 
                    (status === 'approved' && vendor.approved) ||
                    (status === 'pending' && !vendor.approved);

                return matchesSearch && matchesStatus;
            });
            
            // Sort by approved status (pending first for admin attention) then by name
            filteredVendors.sort((a, b) => {
                // Pending (false) comes before Approved (true)
                if (a.approved !== b.approved) {
                    return a.approved ? 1 : -1; 
                }
                // Then sort alphabetically by name
                return a.name.localeCompare(b.name);
            });


            vendorListElement.innerHTML = '';
            if (filteredVendors.length === 0) {
                listMessage.textContent = 'No vendors match the current filters.';
                vendorListElement.appendChild(listMessage);
                listMessage.classList.remove('hidden');
                return;
            } else {
                listMessage.classList.add('hidden');
            }

            filteredVendors.forEach(vendor => {
                const vendorCard = document.createElement('div');
                vendorCard.className = `p-4 rounded-xl shadow-md transition duration-150 ease-in-out border ${vendor.approved ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}`;
                
                const statusBadge = `<span class="px-2 py-0.5 text-xs font-semibold rounded-full ${vendor.approved ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                    ${vendor.approved ? 'APPROVED' : 'PENDING'}
                </span>`;

                vendorCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-gray-800">${vendor.name}</h3>
                        ${statusBadge}
                    </div>
                    <p class="text-sm text-gray-600 mb-1"><strong>Category:</strong> ${vendor.category}</p>
                    <p class="text-sm text-gray-600 mb-2"><strong>Location:</strong> ${vendor.location}</p>
                    <p class="text-sm text-gray-500 mb-3 line-clamp-2">${vendor.description || 'No description provided.'}</p>
                    
                    <div class="flex space-x-2">
                        <button data-id="${vendor.id}" data-action="edit" class="edit-btn text-sm font-medium text-primary-blue hover:text-blue-700 transition duration-150">Edit</button>
                        <span class="text-gray-300">|</span>
                        <button data-id="${vendor.id}" data-action="delete" class="delete-btn text-sm font-medium text-red-600 hover:text-red-800 transition duration-150">Delete</button>
                    </div>
                `;
                vendorListElement.appendChild(vendorCard);
            });
        };

        // --- Event Handlers ---

        const loadVendorToForm = (vendor) => {
            document.getElementById('vendor-id').value = vendor.id || '';
            document.getElementById('name').value = vendor.name || '';
            document.getElementById('category').value = vendor.category || '';
            document.getElementById('contact').value = vendor.contact || '';
            document.getElementById('location').value = vendor.location || '';
            document.getElementById('description').value = vendor.description || '';
            document.getElementById('approved').checked = vendor.approved || false;
            submitButton.textContent = vendor.id ? 'Update Vendor' : 'Add Vendor';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const clearForm = () => {
            vendorForm.reset();
            document.getElementById('vendor-id').value = '';
            submitButton.textContent = 'Add Vendor';
        };
        
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            submitButton.disabled = true;
            submitButton.textContent = submitButton.textContent.includes('Update') ? 'Updating...' : 'Adding...';

            const id = document.getElementById('vendor-id').value;
            const name = document.getElementById('name').value.trim();
            const category = document.getElementById('category').value;
            const contact = document.getElementById('contact').value.trim();
            const location = document.getElementById('location').value.trim();
            const description = document.getElementById('description').value.trim();
            const approved = document.getElementById('approved').checked;

            if (!name || !category || !location) {
                await showModal('Missing Info', 'Please ensure you fill in the Name, Category, and Location fields.', 'OK', true);
                submitButton.disabled = false;
                submitButton.textContent = id ? 'Update Vendor' : 'Add Vendor';
                return;
            }

            await saveVendor({ id, name, category, contact, location, description, approved });

            submitButton.disabled = false;
            submitButton.textContent = id ? 'Update Vendor' : 'Add Vendor';
        };

        const handleListClick = (e) => {
            const target = e.target;
            const action = target.getAttribute('data-action');
            const vendorId = target.getAttribute('data-id');

            if (action && vendorId) {
                const vendor = allVendors.find(v => v.id === vendorId);
                if (!vendor) return;

                if (action === 'edit') {
                    loadVendorToForm(vendor);
                } else if (action === 'delete') {
                    deleteVendor(vendorId);
                }
            }
        };
        
        const handleFilterChange = () => {
            currentFilter.search = searchInput.value.trim();
            currentFilter.status = filterStatus.value;
            renderVendorList();
        };

        // --- Initialization and Real-time Listener ---

        const setupRealtimeListener = () => {
            const vendorsQuery = query(getVendorCollectionRef());

            onSnapshot(vendorsQuery, (snapshot) => {
                allVendors = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log("Realtime update received. Total vendors:", allVendors.length);
                renderVendorList();
            }, (error) => {
                console.error("Firestore realtime listener failed:", error);
                errorMessage.textContent = "Error fetching data. See console.";
                errorMessage.classList.remove('hidden');
            });
        };

        const initApp = () => {
            // All Firebase setup is complete. Hide loading screen and show the app.
            userIdDisplay.textContent = userId;
            loadingScreen.classList.add('opacity-0');
            appContainer.classList.add('opacity-100');
            setTimeout(() => loadingScreen.classList.add('hidden'), 300);

            // Set up all event listeners
            vendorForm.addEventListener('submit', handleFormSubmit);
            clearButton.addEventListener('click', clearForm);
            vendorListElement.addEventListener('click', handleListClick);
            searchInput.addEventListener('input', handleFilterChange);
            filterStatus.addEventListener('change', handleFilterChange);
            
            // Start the real-time data listener
            setupRealtimeListener();
            
            console.log("Admin Application Initialized.");
        };

        // --- Core Firebase Initialization Logic (Self-Executing Function) ---
        (async () => {
            try {
                // CRITICAL STEP: Log the configuration being used
                console.log("Final Firebase Config Used:", firebaseConfig);

                // 1. Initialize Firebase 
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 2. CRITICAL DEBUGGING STEP: Set Firebase Auth/Firestore log level to Debug
                setLogLevel('debug');
                console.log("Firebase logging set to 'debug'. Check console for detailed Auth messages.");


                // 3. Authentication
                let user;
                if (initialAuthToken) {
                    user = (await signInWithCustomToken(auth, initialAuthToken)).user;
                    console.log("Signed in with custom token.");
                } else {
                    user = (await signInAnonymously(auth)).user;
                    console.warn("No custom token found. Signed in anonymously.");
                }

                // 4. Get User ID (guaranteed after sign-in)
                userId = user.uid || crypto.randomUUID();
                
                // 5. Start the Application
                initApp();

            } catch (error) {
                console.error("CRITICAL FIREBASE INITIALIZATION ERROR:", error);
                
                // Show a detailed error message in the UI for visibility
                const displayError = (error.message.includes('configuration-not-found'))
                    ? "Auth Config Missing: The 'authDomain' key required by Firebase Auth is missing from the configuration. (Fix applied automatically in code, check console for configuration details.)"
                    : error.message;

                loadingScreen.innerHTML = `
                    <div class="p-6 bg-red-100 border-l-4 border-red-500 text-red-700 max-w-xl mx-auto rounded-lg shadow-lg">
                        <p class="font-bold text-lg">Initialization Failed</p>
                        <p class="text-sm mt-2">Could not connect to the database. Please check the console for critical error details.</p>
                        <p class="mt-4 font-mono text-xs break-all">Error: ${displayError}</p>
                    </div>
                `;
                loadingScreen.classList.remove('opacity-0');
                loadingScreen.classList.remove('hidden');
                loadingScreen.classList.add('flex');
            }
        })();

    </script>
</body>
</html>
