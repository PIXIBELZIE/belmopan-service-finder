<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Sign-up & Approval System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .admin-tag {
            background-color: #f0fdf4;
            color: #15803d;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
        }
        .vendor-item {
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s;
        }
        .vendor-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <div id="loading-indicator" class="text-gray-500 mt-20">Loading application...</div>
    
    <div id="main-app" class="w-full max-w-4xl hidden">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-gray-900">Vendor Management Portal</h1>
            <p class="text-gray-500 mt-2" id="auth-status"></p>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="card p-6 sm:p-8">
            <!-- Content will be injected here (Admin Dashboard or Vendor Form) -->
        </div>
        
        <!-- Error Message Box -->
        <div id="message-box" class="mt-4 p-4 text-sm rounded-lg text-red-700 bg-red-100 hidden" role="alert"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, deleteDoc, addDoc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES & FIREBASE SETUP (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-vendor-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let userRole = null;
        let unsubscribePending = null;
        let unsubscribeApproved = null;
        let isAuthReady = false;

        // Firestore Paths Helpers
        const getProfileDocRef = (uid) => doc(db, `/artifacts/${appId}/users/${uid}/profile/role`);
        const getPendingCollectionRef = () => collection(db, `/artifacts/${appId}/public/data/pending_vendors`);
        const getApprovedCollectionRef = () => collection(db, `/artifacts/${appId}/public/data/approved_vendors`);
        
        // UI Elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const mainApp = document.getElementById('main-app');
        const contentArea = document.getElementById('content-area');
        const authStatusElement = document.getElementById('auth-status');
        const messageBox = document.getElementById('message-box');

        // Utility Functions
        const showMessage = (msg, isError = true) => {
            messageBox.textContent = msg;
            messageBox.className = isError 
                ? 'mt-4 p-4 text-sm rounded-lg text-red-700 bg-red-100' 
                : 'mt-4 p-4 text-sm rounded-lg text-green-700 bg-green-100';
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        };

        const generateCSV = (data) => {
            if (!data || data.length === 0) return '';
            // Ensure headers are consistent, even if some fields are missing in some docs
            const headers = ["id", "userId", "name", "email", "description", "submittedAt", "approvedBy", "approvedAt"];
            
            const rows = data.map(obj => 
                headers.map(key => {
                    let val = obj[key] || '';
                    if (key === 'description' && typeof val === 'string') {
                        // Sanitize string content for CSV (escape quotes)
                        val = val.replace(/"/g, '""');
                    }
                    return `"${String(val)}"`;
                }).join(',')
            );
            return [headers.join(','), ...rows].join('\n');
        };

        const downloadData = (data, filename, type) => {
            const blob = new Blob([data], { type: `${type};charset=utf-8;` });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- AUTHENTICATION & ROLE MANAGEMENT ---

        onAuthStateChanged(auth, async (user) => {
            loadingIndicator.classList.add('hidden');
            mainApp.classList.remove('hidden');

            if (user) {
                userId = user.uid;
                
                // 1. Check/Set User Role
                await loadOrCreateUserRole(user.uid);
                
                // 2. Render UI based on role
                renderApp();

            } else {
                // Not authenticated yet, attempt sign-in
                try {
                    if (initialAuthToken) {
                        // Designated Admin (Super Admin)
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Standard Vendor/User (Anonymous)
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Auth Error:", error);
                    showMessage(`Authentication failed: ${error.message}`, true);
                }
            }
            isAuthReady = true;
        });

        const loadOrCreateUserRole = async (uid) => {
            const profileRef = getProfileDocRef(uid);
            const profileSnap = await getDoc(profileRef);

            if (profileSnap.exists()) {
                userRole = profileSnap.data().role;
            } else {
                // New user - determine role based on token presence
                if (initialAuthToken) {
                    // First user with token is the Super Admin
                    userRole = 'admin';
                } else {
                    // Anonymous user is a pending vendor
                    userRole = 'pending_vendor';
                }
                await setDoc(profileRef, { role: userRole, userId: uid, createdAt: new Date().toISOString() });
            }
        };

        // --- VENDOR SIGN-UP FORM ---

        const renderVendorForm = () => {
            authStatusElement.innerHTML = `Signed in as: <span class="font-mono text-xs">${userId}</span> | Status: <span class="font-bold text-yellow-600">Pending Approval</span>`;
            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Vendor Sign-Up</h2>
                <p class="mb-6 text-gray-600">Please fill out the form below. Your request will be reviewed by an administrator. Your unique ID for this session is: <code class="font-mono bg-gray-100 p-1 rounded">${userId}</code></p>
                <form id="vendor-form" class="space-y-4">
                    <div>
                        <label for="vendorName" class="block text-sm font-medium text-gray-700 mb-1">Vendor/Company Name</label>
                        <input type="text" id="vendorName" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="contactEmail" class="block text-sm font-medium text-gray-700 mb-1">Contact Email (for welcome/approval email)</label>
                        <input type="email" id="contactEmail" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Brief Description of Services</label>
                        <textarea id="description" rows="3" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <button type="submit" id="submit-btn" class="w-full py-2 px-4 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150">Submit for Approval</button>
                </form>
                <div id="vendor-info-status" class="mt-4 p-3 text-center rounded-md bg-blue-100 text-blue-800 hidden">
                    Your sign-up is currently under review. Thank you!
                </div>
            `;
            
            const form = document.getElementById('vendor-form');
            form.addEventListener('submit', handleVendorSubmit);

            // Check if vendor data already exists in pending collection
            const checkExisting = async () => {
                const q = query(getPendingCollectionRef(), where("userId", "==", userId));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    form.classList.add('hidden');
                    document.getElementById('vendor-info-status').classList.remove('hidden');
                }
            };
            checkExisting();
        };

        const handleVendorSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = document.getElementById('submit-btn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const vendorName = form.vendorName.value;
            const contactEmail = form.contactEmail.value;
            const description = form.description.value;

            try {
                await addDoc(getPendingCollectionRef(), {
                    userId: userId,
                    name: vendorName,
                    email: contactEmail,
                    description: description,
                    submittedAt: new Date().toISOString()
                });

                form.classList.add('hidden');
                document.getElementById('vendor-info-status').textContent = "Your sign-up has been submitted and is awaiting admin approval!";
                document.getElementById('vendor-info-status').classList.remove('hidden');
                showMessage("Sign-up successful! Waiting for admin approval.", false);

            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Error submitting sign-up. Please try again.", true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit for Approval';
            }
        };

        // --- ADMIN DASHBOARD ---

        const renderAdminDashboard = (pendingVendors) => {
            authStatusElement.innerHTML = `Signed in as: <span class="font-mono text-xs">${userId}</span> | Role: <span class="admin-tag">SUPER ADMIN</span>`;
            
            const pendingListHTML = pendingVendors.length > 0
                ? pendingVendors.map(v => `
                    <div class="vendor-item p-4 flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0">
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-900">${v.name}</p>
                            <p class="text-sm text-gray-600">Email: ${v.email}</p>
                            <p class="text-xs text-gray-400">User ID: <span class="font-mono">${v.userId}</span></p>
                            <p class="text-xs text-gray-400">Submitted: ${new Date(v.submittedAt).toLocaleString()}</p>
                            <p class="text-sm mt-1 text-gray-700 italic">${v.description}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${v.id}" data-action="approve" class="py-1 px-3 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition">Approve</button>
                            <button data-id="${v.id}" data-action="reject" class="py-1 px-3 bg-red-500 text-white text-sm font-medium rounded-md hover:bg-red-600 transition">Reject</button>
                        </div>
                    </div>
                `).join('')
                : '<p class="p-4 text-center text-gray-500">No vendors currently pending approval. 🎉</p>';
            
            contentArea.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Admin Dashboard</h2>
                
                <div class="mb-6 space-y-2 sm:space-y-0 sm:space-x-4 flex flex-col sm:flex-row">
                    <button id="export-csv" class="flex-1 py-2 px-4 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 transition duration-150">Export Pending as CSV</button>
                    <button id="export-json" class="flex-1 py-2 px-4 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 transition duration-150">Export Pending as JSON</button>
                    <a id="google-sheets-proxy" href="https://docs.google.com/forms/u/0/create?usp=pp_url" target="_blank" class="flex-1 py-2 px-4 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition duration-150 text-center">
                        Open Google Sheets (Manual Email Trigger)
                    </a>
                </div>

                <h3 class="text-xl font-medium text-gray-800 mb-3 border-b pb-2">Pending Vendors (${pendingVendors.length})</h3>
                <div id="pending-list" class="divide-y divide-gray-100 border border-gray-200 rounded-lg">
                    ${pendingListHTML}
                </div>

                <h3 class="text-xl font-medium text-gray-800 mt-6 mb-3 border-b pb-2">Approved Vendors List</h3>
                <p class="text-sm text-gray-500 mb-3">This list can be exported separately if needed for ongoing mailing lists.</p>
                <div id="approved-vendors-list" class="text-gray-600">
                    Loading approved vendors...
                </div>
            `;
            
            // Attach event listeners for Approve/Reject
            const pendingList = document.getElementById('pending-list');
            pendingList.addEventListener('click', (e) => {
                const target = e.target;
                const id = target.getAttribute('data-id');
                const action = target.getAttribute('data-action');
                if (id && action) {
                    const vendorData = pendingVendors.find(v => v.id === id);
                    if (action === 'approve') {
                        handleVendorAction(id, 'approve', vendorData);
                    } else if (action === 'reject') {
                        handleVendorAction(id, 'reject', vendorData);
                    }
                }
            });

            // Attach event listeners for Export
            document.getElementById('export-csv').addEventListener('click', () => {
                // Ensure we include 'id' field for unique identifier in export
                const exportData = pendingVendors.map(v => ({ id: v.id, userId: v.userId, name: v.name, email: v.email, description: v.description, submittedAt: v.submittedAt }));
                const csvData = generateCSV(exportData);
                downloadData(csvData, 'pending_vendors.csv', 'text/csv');
            });
            document.getElementById('export-json').addEventListener('click', () => {
                const jsonData = JSON.stringify(pendingVendors.map(v => ({ id: v.id, userId: v.userId, name: v.name, email: v.email, description: v.description, submittedAt: v.submittedAt })), null, 2);
                downloadData(jsonData, 'pending_vendors.json', 'application/json');
            });

            // Start listening to approved vendors
            startApprovedVendorsListener();
        };

        const renderApprovedVendors = (approvedVendors) => {
            const approvedList = document.getElementById('approved-vendors-list');
            if (!approvedList) return; // Guard for non-admin view
            
            if (approvedVendors.length === 0) {
                approvedList.innerHTML = '<p class="text-center text-gray-500 py-4">No vendors have been approved yet.</p>';
                return;
            }

            approvedList.innerHTML = approvedVendors.map(v => `
                <div class="p-3 bg-gray-50 mb-2 rounded-md border border-gray-100">
                    <p class="font-semibold text-blue-700">${v.name}</p>
                    <p class="text-sm text-gray-600">Email: ${v.email}</p>
                    <p class="text-xs text-gray-400">Approved: ${new Date(v.approvedAt).toLocaleDateString()}</p>
                </div>
            `).join('');
        };

        const handleVendorAction = async (docId, action, vendorData) => {
            try {
                // 1. Delete from pending_vendors
                await deleteDoc(doc(getPendingCollectionRef(), docId));

                if (action === 'approve') {
                    // 2. Add to approved_vendors
                    await setDoc(doc(getApprovedCollectionRef(), docId), {
                        ...vendorData,
                        approvedBy: userId,
                        approvedAt: new Date().toISOString()
                    });

                    // 3. Update the vendor's role to 'vendor'
                    const profileRef = getProfileDocRef(vendorData.userId);
                    // Only update the user profile if they still exist (haven't cleared cache/left the page)
                    await updateDoc(profileRef, { role: 'vendor' });

                    showMessage(`Vendor '${vendorData.name}' has been APPROVED and granted vendor access.`, false);
                } else if (action === 'reject') {
                    // 2. Only delete from pending_vendors. The user keeps the 'pending_vendor' role.
                    showMessage(`Vendor '${vendorData.name}' has been REJECTED.`, false);
                }

            } catch (e) {
                console.error(`Error performing ${action} action: `, e);
                showMessage(`Failed to process vendor action: ${e.message}. Note: The pending entry was removed.`, true);
            }
        };

        // --- FIRESTORE LISTENERS ---

        const startPendingVendorsListener = () => {
            if (unsubscribePending) unsubscribePending(); // Cleanup old listener
            const q = query(getPendingCollectionRef());
            
            unsubscribePending = onSnapshot(q, (snapshot) => {
                const pendingVendors = [];
                snapshot.forEach((doc) => {
                    // Add document ID to the data object
                    pendingVendors.push({ id: doc.id, ...doc.data() });
                });
                // Rerender the admin dashboard with new data
                if (userRole === 'admin') {
                    renderAdminDashboard(pendingVendors);
                }
            }, (error) => {
                console.error("Error listening to pending vendors:", error);
                showMessage("Cannot load pending vendors in real-time.", true);
            });
        };

        const startApprovedVendorsListener = () => {
            if (unsubscribeApproved) unsubscribeApproved(); // Cleanup old listener
            const q = query(getApprovedCollectionRef());
            
            unsubscribeApproved = onSnapshot(q, (snapshot) => {
                const approvedVendors = [];
                snapshot.forEach((doc) => {
                    approvedVendors.push({ id: doc.id, ...doc.data() });
                });
                // Rerender the approved vendors list
                if (userRole === 'admin') {
                    renderApprovedVendors(approvedVendors);
                }
            }, (error) => {
                console.error("Error listening to approved vendors:", error);
                showMessage("Cannot load approved vendors in real-time.", true);
            });
        };

        // --- MAIN RENDER FUNCTION ---

        const renderApp = () => {
            if (!isAuthReady) return;

            // Stop any existing listeners before rendering a new view
            if (unsubscribePending) unsubscribePending();
            if (unsubscribeApproved) unsubscribeApproved();

            if (userRole === 'admin') {
                startPendingVendorsListener(); // This will trigger the first renderAdminDashboard
            } else if (userRole === 'pending_vendor') {
                renderVendorForm();
            } else if (userRole === 'vendor') {
                // Approved Vendor View
                authStatusElement.innerHTML = `Signed in as: <span class="font-mono text-xs">${userId}</span> | Status: <span class="font-bold text-green-600">Approved Vendor</span>`;
                contentArea.innerHTML = `
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Welcome, Approved Vendor!</h2>
                    <p class="text-gray-600">Your account is active. You can now access vendor resources.</p>
                    <div class="mt-4 p-4 rounded-md bg-green-50 border border-green-200 text-green-800">
                        <p class="font-medium">Account Status: Active</p>
                        <p class="text-sm">This is where you would place specific tools or links for approved vendors.</p>
                    </div>
                `;
            } else {
                // Fallback for unknown state
                authStatusElement.textContent = `User ID: ${userId} | Status: Unknown Role`;
                contentArea.innerHTML = `<p class="text-center text-red-500">Your user role could not be determined or is invalid. Please contact support.</p>`;
            }
        };

    </script>
</body>
</html>
